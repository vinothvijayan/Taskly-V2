import{c as Ae,az as Oe,F as Ke,av as Pe,a$ as qe,G as Ve,u as _e,b0 as He,r as i,b1 as xe,b2 as Ye,b3 as Je,b4 as Qe,R as E,Y as pe,j as e,m as N,b5 as H,$ as ge,I as z,S as F,U as fe,A as B,aB as G,k as U,B as je,L as A,M as Y,q as y,V as O,b6 as we,b7 as We,b8 as Xe,ah as be,ai as Ne,aj as ye,ak as f,b9 as Ze,aT as es}from"./index-BOMCLsi_.js";import{a as ve,u as ss}from"./useTouchGestures-BNpwY5ui.js";import{S as ke}from"./send-5-KT-IdZ.js";import{P as Ce}from"./plus-jVcLPC9x.js";import{C as Se}from"./copy-BedkSnvK.js";/**
 * @license lucide-react v0.539.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ts=[["path",{d:"M20 18v-2a4 4 0 0 0-4-4H4",key:"5vmcpk"}],["path",{d:"m9 17-5-5 5-5",key:"nvlc11"}]],Me=Ae("reply",ts);function os(){const J=Oe(),{user:n,userProfile:Q}=Ke(),{teamMembers:Le,addTask:Re}=Pe(),{onlineStatus:W,markChatAsRead:as,markMessagesAsReadBatch:Ie,unreadCounts:X}=qe(),{toast:h}=Ve(),Te=_e(),{setChatOpenMobile:Z,setOpen:v}=He(),{impact:De}=ss(),[d,ee]=i.useState(null),[m,se]=i.useState([]),[x,j]=i.useState(""),[te,K]=i.useState(!1),[k,ae]=i.useState(!1),[$e,re]=i.useState(!1),[C,ne]=i.useState(""),[Ee,ze]=i.useState({}),P=i.useRef(null),q=i.useRef(null),S=i.useRef(null),M=i.useRef(!0),w=i.useRef(null);i.useEffect(()=>{v&&(window.innerWidth>=768?v(!1):v(!0))},[v]),i.useEffect(()=>{var s;(s=P.current)==null||s.scrollIntoView({behavior:"smooth"})},[m]),i.useEffect(()=>(d&&n&&(console.time("Chat Load Time"),Fe(d.uid)),()=>{if(q.current)try{xe(q.current)}catch(s){console.warn(s)}if(S.current)try{xe(S.current)}catch(s){console.warn(s)}}),[d,n]),i.useEffect(()=>{d&&w.current&&w.current.focus()},[d]);const b=(s,a)=>[s,a].sort().join("_"),Fe=s=>{if(!n)return;K(!0);const a=b(n.uid,s),t=Ye(E(O,`chats/${a}/messages`),Qe("timestamp"),Je(50));q.current=t,pe(t,r=>{if(!M.current)return;const l=r.val();if(l){const o=Object.entries(l).map(([c,g])=>({id:c,...g}));o.sort((c,g)=>c.timestamp-g.timestamp),se(o),console.timeEnd("Chat Load Time"),de(s);const u=o.map(c=>c.id);Ie(a,u).catch(c=>console.warn(c))}else se([]),console.timeEnd("Chat Load Time"),de(s);K(!1)},r=>{console.error("Error listening to chat messages:",r),M.current&&(h({title:"Chat connection error",variant:"destructive"}),K(!1))})},de=s=>{if(!n)return;const a=b(n.uid,s);S.current=E(O,`messageStatus/${a}`),pe(S.current,t=>{if(!M.current)return;const r=t.val(),l={};r&&Object.entries(r).forEach(([o,u])=>{u&&u[s]&&(l[o]=!0)}),ze(l)})},V=async()=>{if(!x.trim()||!d||!n||!Q)return;const s=x.trim();j(""),ae(!0);try{const a=b(n.uid,d.uid),t=E(O,`chats/${a}/messages`),r={senderId:n.uid,senderName:Q.displayName||n.email||"Unknown",senderEmail:n.email||"",message:s,timestamp:Date.now(),type:"text"};await we(t,r);const l=E(O,`chatRooms/${a}`);we(l,{participants:[n.uid,d.uid],lastActivity:We(),lastMessage:r}).catch(o=>console.warn(o)),Xe.addInAppNotification(d.uid,`New message from ${r.senderName}`,r.message.substring(0,50),"chat",{chatRoomId:a,senderId:n.uid,senderName:r.senderName}).catch(o=>console.warn(o))}catch(a){console.error("Error sending message:",a),j(s),h({title:"Failed to send message",variant:"destructive"})}finally{ae(!1)}},ie=s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),V())},le=s=>s.senderId!==(n==null?void 0:n.uid)?null:Ee[s.id]?e.jsx(Ze,{className:"h-3 w-3 text-sky-500"}):e.jsx(es,{className:"h-3 w-3 text-muted-foreground/70"}),oe=s=>new Date(s).toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0}),L=(s,a)=>s!=null&&s.trim()?s.split(" ").map(t=>t[0]).join("").toUpperCase().slice(0,2):(a==null?void 0:a.split("@")[0].slice(0,2).toUpperCase())||"U",R=s=>{const a=Math.floor((Date.now()-s)/6e4);if(a<1)return"Just now";if(a<60)return`${a}m ago`;const t=Math.floor(a/60);return t<24?`${t}h ago`:`${Math.floor(t/24)}d ago`},I=s=>{var a;return((a=W[s])==null?void 0:a.online)||!1},T=s=>{var a;return((a=W[s])==null?void 0:a.lastSeen)||Date.now()},D=()=>{const s=[];let a="";return m.forEach((t,r)=>{var u,c,g,he;const l=new Date(t.timestamp).toDateString();if(l!==a){a=l;const Ge=new Date().toDateString(),Ue=new Date(Date.now()-864e5).toDateString();let _=new Date(t.timestamp).toLocaleDateString("en-US",{weekday:"long",month:"long",day:"numeric"});l===Ge?_="Today":l===Ue&&(_="Yesterday"),s.push({type:"date",data:_})}const o=t.senderId===((u=m[r-1])==null?void 0:u.senderId)&&t.timestamp-((c=m[r-1])==null?void 0:c.timestamp)<3e5;s.push({type:"message",data:{...t,isFirstInGroup:!o,isLastInGroup:r===m.length-1||((g=m[r+1])==null?void 0:g.senderId)!==t.senderId||((he=m[r+1])==null?void 0:he.timestamp)-t.timestamp>=3e5}})}),s},$=Le.filter(s=>{var a;return s.uid!==(n==null?void 0:n.uid)&&(((a=s.displayName)==null?void 0:a.toLowerCase().includes(C.toLowerCase()))||s.email.toLowerCase().includes(C.toLowerCase()))}),ce=s=>{ee(s),re(!0),Z(!0)},Be=()=>{re(!1),ee(null),Z(!1)},p=async s=>{try{De("light");const a={title:s.message.substring(0,50)+(s.message.length>50?"...":""),description:`Created from chat message by ${s.senderName}:

"${s.message}"`,priority:"medium",status:"todo",assignedTo:[]};await Re(a),h({title:"Task created! 📝"})}catch(a){console.error("Error creating task from message:",a),h({title:"Error creating task",variant:"destructive"})}},me=s=>navigator.clipboard.writeText(s.message).then(()=>h({title:"Copied"})).catch(()=>h({title:"Error",variant:"destructive"})),ue=s=>{var a;j(`@${s.senderName}: "${s.message.substring(0,30)}..."

`),(a=w.current)==null||a.focus()};return i.useEffect(()=>()=>{M.current=!1},[]),e.jsx("div",{className:"h-full w-full bg-background flex overflow-hidden min-h-0",children:Te?e.jsx(e.Fragment,{children:$e?d&&e.jsxs("div",{className:"flex-1 flex flex-col w-full min-h-0 overflow-hidden",children:[e.jsxs("div",{className:"bg-[#008069] text-white px-4 py-4 flex items-center gap-3 shadow-lg z-20",children:[e.jsx(N,{variant:"ghost",size:"icon",onClick:Be,className:"text-white hover:bg-white/10 -ml-2",children:e.jsx(H,{className:"h-5 w-5"})}),e.jsxs(B,{className:"h-11 w-11 ring-2 ring-white/20",children:[e.jsx(G,{src:d.photoURL||""}),e.jsx(U,{className:"bg-white/20 text-white font-semibold",children:L(d.displayName,d.email)})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-semibold",children:d.displayName||"Team Member"}),e.jsx("p",{className:"text-sm text-white/80",children:I(d.uid)?"Online":`Last seen ${R(T(d.uid))}`})]})]}),e.jsx("div",{className:"flex-1 whatsapp-wallpaper overflow-hidden",children:e.jsx(F,{className:"h-full",children:e.jsxs("div",{className:"p-4 space-y-1 pb-16",children:[te?e.jsx("div",{className:"flex items-center justify-center py-16",children:e.jsx(A,{className:"h-8 w-8 animate-spin text-primary"})}):D().length===0?e.jsxs("div",{className:"text-center py-16 text-muted-foreground",children:[e.jsx(Y,{className:"h-16 w-16 mx-auto mb-6 opacity-30"}),e.jsx("p",{className:"text-base",children:"Start a conversation"})]}):D().map((s,a)=>{if(s.type==="date")return e.jsx("div",{className:"flex justify-center my-6",children:e.jsx("div",{className:"bg-white/90 dark:bg-muted/90 text-xs px-4 py-2 rounded-full text-muted-foreground shadow-sm",children:s.data})},`date-${a}`);const t=s.data,r=t.senderId===(n==null?void 0:n.uid),l=()=>{const o=ve({onSwipeRight:r?void 0:()=>p(t),onSwipeLeft:r?()=>p(t):void 0},{threshold:80,velocityThreshold:.2});return e.jsxs(be,{children:[e.jsx(Ne,{asChild:!0,children:e.jsxs("div",{ref:o,className:y("max-w-[85%] px-4 py-3 text-sm break-words shadow-sm cursor-pointer",r?"bg-[#DCF8C6] text-black dark:bg-emerald-900/50 dark:text-white":"bg-white text-black dark:bg-muted dark:text-foreground",t.isFirstInGroup&&t.isLastInGroup?"rounded-lg":t.isFirstInGroup?r?"rounded-t-lg rounded-bl-lg rounded-br-md":"rounded-t-lg rounded-br-lg rounded-bl-md":t.isLastInGroup?r?"rounded-b-lg rounded-tl-lg rounded-tr-md":"rounded-b-lg rounded-tr-lg rounded-tl-md":r?"rounded-l-lg rounded-tr-md rounded-br-md":"rounded-r-lg rounded-tl-md rounded-bl-md"),children:[e.jsx("p",{className:"leading-relaxed",children:t.message}),e.jsxs("div",{className:"flex items-center justify-end gap-1 mt-1",children:[e.jsx("span",{className:"text-xs opacity-70",children:oe(t.timestamp)}),r&&le(t)]})]})}),e.jsxs(ye,{className:"w-48 bg-background border shadow-lg z-50",children:[e.jsxs(f,{onClick:()=>p(t),children:[e.jsx(Ce,{className:"mr-2 h-4 w-4"}),"Create Task"]}),e.jsxs(f,{onClick:()=>me(t),children:[e.jsx(Se,{className:"mr-2 h-4 w-4"}),"Copy Message"]}),e.jsxs(f,{onClick:()=>ue(t),children:[e.jsx(Me,{className:"mr-2 h-4 w-4"}),"Reply"]})]})]})};return e.jsx("div",{className:y("flex mb-1",r?"justify-end":"justify-start"),children:e.jsx(l,{})},t.id)}),e.jsx("div",{ref:P})]})})}),e.jsx("div",{className:"bg-background border-t px-4 py-3 shadow-lg z-10",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(z,{value:x,onChange:s=>j(s.target.value),onKeyDown:ie,ref:w,placeholder:"Type a message",autoFocus:!0,className:"flex-1 rounded-full border-0 bg-muted/30"}),e.jsx(N,{onClick:V,disabled:!x.trim()||k,size:"icon",className:"rounded-full bg-[#25D366] hover:bg-[#20B358] text-white shadow-md",children:k?e.jsx(A,{className:"h-4 w-4 animate-spin"}):e.jsx(ke,{className:"h-4 w-4"})})]})})]}):e.jsxs("div",{className:"flex-1 flex flex-col w-full min-h-0",children:[e.jsxs("div",{className:"bg-[#008069] text-white px-4 py-4 flex items-center gap-3 shadow-lg z-20 sticky top-0 pt-safe",children:[e.jsx(N,{variant:"ghost",size:"icon",onClick:()=>J("/"),className:"text-white hover:bg-white/10 -ml-2",children:e.jsx(H,{className:"h-5 w-5"})}),e.jsx("h1",{className:"text-xl font-semibold",children:"Chats"})]}),e.jsx("div",{className:"px-4 py-3 border-b bg-white dark:bg-background shadow-sm z-10 sticky top-[72px]",children:e.jsxs("div",{className:"relative",children:[e.jsx(ge,{className:"absolute left-3 top-3 h-4 w-4 text-muted-foreground"}),e.jsx(z,{placeholder:"Search chats...",value:C,onChange:s=>ne(s.target.value),className:"pl-10 border-0 bg-muted/30 rounded-xl"})]})}),e.jsx(F,{className:"flex-1",children:e.jsx("div",{className:"divide-y divide-border/50",children:$.length===0?e.jsxs("div",{className:"text-center py-12 text-muted-foreground",children:[e.jsx(fe,{className:"h-12 w-12 mx-auto mb-4 opacity-30"}),e.jsx("p",{className:"text-sm",children:"No team members"})]}):$.map(s=>{const a=n?b(n.uid,s.uid):"",t=X[a]||0;return e.jsx("div",{className:"px-4 py-4 hover:bg-muted/30 cursor-pointer transition-colors active:bg-muted/50",onClick:()=>ce(s),children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(B,{className:"h-14 w-14 ring-2 ring-background shadow-sm",children:[e.jsx(G,{src:s.photoURL||""}),e.jsx(U,{className:"bg-primary/10 text-primary font-semibold",children:L(s.displayName,s.email)})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"flex items-center justify-between mb-1",children:e.jsx("p",{className:"font-semibold truncate text-foreground",children:s.displayName||"Team Member"})}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:I(s.uid)?e.jsx("span",{className:"text-green-600 font-medium",children:"Online"}):`Last seen ${R(T(s.uid))}`}),t>0&&e.jsx(je,{className:"bg-[#25D366] text-white text-xs px-2 py-1 rounded-full min-w-[20px] h-5 flex items-center justify-center",children:t})]})]})]})},s.uid)})})})]})}):e.jsxs("div",{className:"flex w-full",children:[e.jsxs("div",{className:"w-1/3 border-r border-border flex flex-col",children:[e.jsxs("div",{className:"bg-[#008069] text-white px-4 py-4 shadow-lg z-10 flex items-center gap-3",children:[e.jsx(N,{variant:"ghost",size:"icon",onClick:()=>J("/"),className:"text-white hover:bg-white/10 -ml-2",children:e.jsx(H,{className:"h-5 w-5"})}),e.jsx("h1",{className:"text-xl font-semibold",children:"Chats"})]}),e.jsx("div",{className:"px-4 py-3 border-b bg-white dark:bg-background shadow-sm z-10",children:e.jsxs("div",{className:"relative",children:[e.jsx(ge,{className:"absolute left-3 top-3 h-4 w-4 text-muted-foreground"}),e.jsx(z,{placeholder:"Search chats...",value:C,onChange:s=>ne(s.target.value),className:"pl-10 border-0 bg-muted/30 rounded-xl"})]})}),e.jsx(F,{className:"flex-1",children:e.jsx("div",{className:"divide-y divide-border/50",children:$.length===0?e.jsxs("div",{className:"text-center py-12 text-muted-foreground",children:[e.jsx(fe,{className:"h-12 w-12 mx-auto mb-4 opacity-30"}),e.jsx("p",{className:"text-sm",children:"No team members"})]}):$.map(s=>{const a=n?b(n.uid,s.uid):"",t=X[a]||0;return e.jsx("div",{className:y("px-4 py-4 cursor-pointer transition-colors",(d==null?void 0:d.uid)===s.uid?"bg-muted/70":"hover:bg-muted/30"),onClick:()=>ce(s),children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(B,{className:"h-14 w-14 ring-2 ring-background shadow-sm",children:[e.jsx(G,{src:s.photoURL||""}),e.jsx(U,{className:"bg-primary/10 text-primary font-semibold",children:L(s.displayName,s.email)})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"flex items-center justify-between mb-1",children:e.jsx("p",{className:"font-semibold truncate text-foreground",children:s.displayName||"Team Member"})}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:I(s.uid)?e.jsx("span",{className:"text-green-600 font-medium",children:"Online"}):`Last seen ${R(T(s.uid))}`}),t>0&&e.jsx(je,{className:"bg-[#25D366] text-white text-xs px-2 py-1 rounded-full min-w-[20px] h-5 flex items-center justify-center",children:t})]})]})]})},s.uid)})})})]}),e.jsx("div",{className:"flex-1 flex flex-col min-h-0",children:d?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"bg-[#008069] text-white px-4 py-4 flex items-center gap-3 shadow-lg z-20 sticky top-0",children:[e.jsxs(B,{className:"h-11 w-11 ring-2 ring-white/20",children:[e.jsx(G,{src:d.photoURL||""}),e.jsx(U,{className:"bg-white/20 text-white font-semibold",children:L(d.displayName,d.email)})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-semibold",children:d.displayName||"Team Member"}),e.jsx("p",{className:"text-sm text-white/80",children:I(d.uid)?"Online":`Last seen ${R(T(d.uid))}`})]})]}),e.jsx("div",{className:"flex-1 whatsapp-wallpaper overflow-hidden",children:e.jsx(F,{className:"h-full",children:e.jsxs("div",{className:"p-6 space-y-1",children:[te?e.jsx("div",{className:"flex items-center justify-center py-16",children:e.jsx(A,{className:"h-8 w-8 animate-spin text-primary"})}):D().length===0?e.jsxs("div",{className:"text-center py-16 text-muted-foreground",children:[e.jsx(Y,{className:"h-16 w-16 mx-auto mb-6 opacity-30"}),e.jsx("p",{className:"text-base",children:"Start a conversation"})]}):D().map((s,a)=>{if(s.type==="date")return e.jsx("div",{className:"flex justify-center my-6",children:e.jsx("div",{className:"bg-white/90 dark:bg-muted/90 text-xs px-4 py-2 rounded-full text-muted-foreground shadow-sm",children:s.data})},`date-${a}`);const t=s.data,r=t.senderId===(n==null?void 0:n.uid),l=()=>{const o=ve({onSwipeRight:r?void 0:()=>p(t),onSwipeLeft:r?()=>p(t):void 0},{threshold:80,velocityThreshold:.2});return e.jsxs(be,{children:[e.jsx(Ne,{asChild:!0,children:e.jsxs("div",{ref:o,className:y("max-w-[75%] px-4 py-3 text-sm break-words shadow-sm cursor-pointer",r?"bg-[#DCF8C6] text-black dark:bg-emerald-900/50 dark:text-white":"bg-white text-black dark:bg-muted dark:text-foreground",t.isFirstInGroup&&t.isLastInGroup?"rounded-lg":t.isFirstInGroup?r?"rounded-t-lg rounded-bl-lg rounded-br-md":"rounded-t-lg rounded-br-lg rounded-bl-md":t.isLastInGroup?r?"rounded-b-lg rounded-tl-lg rounded-tr-md":"rounded-b-lg rounded-tr-lg rounded-tl-md":r?"rounded-l-lg rounded-tr-md rounded-br-md":"rounded-r-lg rounded-tl-md rounded-bl-md"),children:[e.jsx("p",{className:"leading-relaxed",children:t.message}),e.jsxs("div",{className:"flex items-center justify-end gap-1 mt-1",children:[e.jsx("span",{className:"text-xs opacity-70",children:oe(t.timestamp)}),r&&le(t)]})]})}),e.jsxs(ye,{className:"w-48 bg-background border shadow-lg z-50",children:[e.jsxs(f,{onClick:()=>p(t),children:[e.jsx(Ce,{className:"mr-2 h-4 w-4"}),"Create Task"]}),e.jsxs(f,{onClick:()=>me(t),children:[e.jsx(Se,{className:"mr-2 h-4 w-4"}),"Copy Message"]}),e.jsxs(f,{onClick:()=>ue(t),children:[e.jsx(Me,{className:"mr-2 h-4 w-4"}),"Reply"]})]})]})};return e.jsx("div",{className:y("flex mb-1",r?"justify-end":"justify-start"),children:e.jsx(l,{})},t.id)}),e.jsx("div",{ref:P})]})})}),e.jsx("div",{className:"bg-background border-t px-6 py-4 shadow-lg z-10",children:e.jsxs("div",{className:"flex gap-3",children:[e.jsx(z,{value:x,onChange:s=>j(s.target.value),onKeyDown:ie,ref:w,placeholder:"Type a message",autoFocus:!0,className:"flex-1 rounded-full border-0 bg-muted/30"}),e.jsx(N,{onClick:V,disabled:!x.trim()||k,size:"icon",className:"rounded-full bg-[#25D366] hover:bg-[#20B358] text-white shadow-md",children:k?e.jsx(A,{className:"h-4 w-4 animate-spin"}):e.jsx(ke,{className:"h-4 w-4"})})]})})]}):e.jsx("div",{className:"flex-1 flex items-center justify-center whatsapp-wallpaper",children:e.jsxs("div",{className:"text-center space-y-6 p-8 bg-white/80 dark:bg-muted/80 rounded-2xl shadow-lg backdrop-blur-sm",children:[e.jsx(Y,{className:"h-20 w-20 mx-auto text-muted-foreground/30"}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-semibold mb-2",children:"Select a chat"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Choose a team member to start messaging"})]})]})})})]})})}export{os as default};
