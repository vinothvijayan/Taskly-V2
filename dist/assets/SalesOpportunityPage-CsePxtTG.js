import{c as fe,an as pe,j as e,ao as Ne,ap as I,aq as T,ar as F,as as P,Q as A,at as E,y as ve,z as Ce,B as p,D as ae,u as ne,E as we,au as Se,av as De,aw as be,ax as ye,ay as Le,az as J,a0 as le,ae as Me,a8 as Oe,r as d,f as re,k as $,o as Q,W as ke,aA as Ie,a2 as Te,Y as Fe,Z as Pe,_ as Ee,w as ie,al as Ae,a7 as Ve,aB as We,aC as qe,aD as ze,aE as K,p as Be,a4 as Re,P as _e,x as He,M as Ue,A as X,q as ee,S as $e}from"./index-CIyudF9t.js";import{u as Qe,h as Ye,D as Ze,l as Ge,i as Je,m as Ke,P as Xe,j as ce,k as es,v as ss,C as ts,S as as}from"./alert-dialog-X9brdY__.js";import{C as ns}from"./calendar-HIZ4iU5R.js";import{S as ls,a as rs,b as is,c as cs,d as M}from"./select-cJBpq2ym.js";import{f as oe}from"./format-CrtYonqb.js";import{a as os}from"./skeletons-_JGSiiy5.js";import{D as ds,E as ms}from"./DeleteConfirmationDialog-1nFiE2UZ.js";import{T as xs}from"./textarea-D92HBPlJ.js";import{A as hs}from"./award-CfTIYRrs.js";import{C as us,f as gs}from"./formatDistanceToNow-Bu9e27Lo.js";import{A as js}from"./index-FV4twmxk.js";import"./startOfMonth-DUJ2JjBB.js";import"./subDays-gmpfwhzv.js";import"./en-US-PHonLEz-.js";import"./chevron-left-D9T-5X23.js";/**
 * @license lucide-react v0.539.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const fs=[["path",{d:"M6 3h12",key:"ggurg9"}],["path",{d:"M6 8h12",key:"6g4wlu"}],["path",{d:"m6 13 8.5 8",key:"u1kupk"}],["path",{d:"M6 13h3",key:"wdp6ag"}],["path",{d:"M9 13c6.667 0 6.667-10 0-10",key:"1nkvk2"}]],de=fe("indian-rupee",fs),ps=De({title:J().min(3,"Title must be at least 3 characters."),contact:J().min(2,"Contact name is required."),value:Le.number().min(0,"Value must be a positive number."),closeDate:ye({required_error:"A close date is required."}),stage:be(["Interested Lead","Meeting","Follow-ups","Deals","Closed Won","Closed Lost"]).default("Interested Lead")});function Ns({opportunity:s,onSubmit:x,onCancel:v}){const r=pe({resolver:Se(ps),defaultValues:{title:(s==null?void 0:s.title)||"",contact:(s==null?void 0:s.contact)||"",value:(s==null?void 0:s.value)||0,closeDate:s!=null&&s.closeDate?new Date(s.closeDate):new Date,stage:(s==null?void 0:s.stage)||"Interested Lead"}}),h=n=>{x({...n,closeDate:n.closeDate.toISOString()})};return e.jsx(Ne,{...r,children:e.jsxs("form",{onSubmit:r.handleSubmit(h),className:"space-y-4",children:[e.jsx(I,{control:r.control,name:"title",render:({field:n})=>e.jsxs(T,{children:[e.jsx(F,{children:"Opportunity Title"}),e.jsx(P,{children:e.jsx(A,{placeholder:"e.g., New website for Acme Inc.",...n})}),e.jsx(E,{})]})}),e.jsx(I,{control:r.control,name:"contact",render:({field:n})=>e.jsxs(T,{children:[e.jsx(F,{children:"Contact Name"}),e.jsx(P,{children:e.jsx(A,{placeholder:"Enter contact name...",...n})}),e.jsx(E,{})]})}),e.jsx(I,{control:r.control,name:"value",render:({field:n})=>e.jsxs(T,{children:[e.jsx(F,{children:"Value (₹)"}),e.jsx(P,{children:e.jsx(A,{type:"number",placeholder:"25000",...n})}),e.jsx(E,{})]})}),e.jsx(I,{control:r.control,name:"closeDate",render:({field:n})=>e.jsxs(T,{className:"flex flex-col",children:[e.jsx(F,{children:"Expected Close Date"}),e.jsxs(ve,{children:[e.jsx(Ce,{asChild:!0,children:e.jsx(P,{children:e.jsxs(p,{variant:"outline",className:ae("w-full pl-3 text-left font-normal",!n.value&&"text-muted-foreground"),children:[n.value?oe(n.value,"PPP"):e.jsx("span",{children:"Pick a date"}),e.jsx(ne,{className:"ml-auto h-4 w-4 opacity-50"})]})})}),e.jsx(we,{className:"w-auto p-0",align:"start",children:e.jsx(ns,{mode:"single",selected:n.value,onSelect:n.onChange,disabled:u=>u<new Date("1900-01-01"),initialFocus:!0})})]}),e.jsx(E,{})]})}),e.jsx(I,{control:r.control,name:"stage",render:({field:n})=>e.jsxs(T,{children:[e.jsx(F,{children:"Stage"}),e.jsxs(ls,{onValueChange:n.onChange,defaultValue:n.value,children:[e.jsx(P,{children:e.jsx(rs,{children:e.jsx(is,{placeholder:"Select a stage"})})}),e.jsxs(cs,{children:[e.jsx(M,{value:"Interested Lead",children:"Interested Lead"}),e.jsx(M,{value:"Meeting",children:"Meeting"}),e.jsx(M,{value:"Follow-ups",children:"Follow-ups"}),e.jsx(M,{value:"Deals",children:"Deals"}),e.jsx(M,{value:"Closed Won",children:"Closed Won"}),e.jsx(M,{value:"Closed Lost",children:"Closed Lost"})]})]}),e.jsx(E,{})]})}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4",children:[e.jsx(p,{type:"button",variant:"ghost",onClick:v,children:"Cancel"}),e.jsx(p,{type:"submit",children:"Save Opportunity"})]})]})})}const se=["Interested Lead","Meeting","Follow-ups","Deals","Closed Won","Closed Lost"],me=({opportunity:s,onEdit:x,onDelete:v,isExpanded:r,onExpand:h})=>{const{attributes:n,listeners:u,setNodeRef:C,transform:N,transition:w,isDragging:b}=ce({id:s.id}),{addNoteToOpportunity:g,updateOpportunity:j}=le(),{userProfile:l}=Ve(),[m,y]=d.useState(""),[S,O]=d.useState(""),k={transform:ts.Transform.toString(N),transition:b?"none":w},B=a=>{a.stopPropagation(),m.trim()&&(g(s.id,m),y(""))},V=a=>{a.stopPropagation(),S&&j(s.id,{meetingDate:new Date(S).toISOString(),meetingStatus:"scheduled"})},R=a=>{a.stopPropagation(),j(s.id,{meetingStatus:"done"})},_=a=>a?a.split(" ")[0]:"",W=a=>a?a.split(" ").map(q=>q[0]).join("").toUpperCase().slice(0,2):"";return e.jsx("div",{ref:C,style:k,...n,...u,children:e.jsxs($,{className:ae("mb-4 shadow-sm hover:shadow-md transition-all duration-300 cursor-grab active:cursor-grabbing group",b&&"opacity-50",r&&"ring-2 ring-primary"),onClick:a=>{a.target.closest('button, a, [role="menuitem"], textarea, input')||h()},children:[e.jsxs(Q,{className:"p-4",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsx("p",{className:"font-semibold text-sm mb-2 pr-2 flex-1",children:s.title}),e.jsxs(We,{children:[e.jsx(qe,{asChild:!0,children:e.jsx(p,{variant:"ghost",size:"icon",className:"h-6 w-6 opacity-0 group-hover:opacity-100 transition-opacity",onClick:a=>a.stopPropagation(),children:e.jsx(ms,{className:"h-4 w-4"})})}),e.jsxs(ze,{align:"end",onClick:a=>a.stopPropagation(),children:[e.jsxs(K,{onClick:()=>x(s),children:[e.jsx(as,{className:"mr-2 h-4 w-4"}),"Edit"]}),e.jsxs(K,{onClick:()=>v(s),className:"text-destructive",children:[e.jsx(Be,{className:"mr-2 h-4 w-4"}),"Delete"]})]})]})]}),e.jsxs("div",{className:"space-y-2 text-xs text-muted-foreground",children:[(s.stage!=="Meeting"||r)&&e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(Re,{className:"h-3 w-3"})," ",s.contact]}),s.phone&&e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(_e,{className:"h-3 w-3"})," ",s.phone]}),(s.stage!=="Meeting"||r)&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsx(de,{className:"h-3 w-3"}),s.value.toLocaleString()]}),e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsx(ne,{className:"h-3 w-3"}),new Date(s.closeDate).toLocaleDateString()]})]})]}),s.stage==="Meeting"&&e.jsx("div",{className:"mt-3 pt-3 border-t border-dashed space-y-2",children:s.meetingDate?s.meetingStatus!=="done"?e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"text-xs text-muted-foreground",children:[e.jsx("p",{className:"font-semibold",children:"Meeting Scheduled:"}),e.jsx("p",{children:oe(new Date(s.meetingDate),"PPp")})]}),e.jsx(p,{size:"sm",className:"w-full h-8 bg-green-600 hover:bg-green-700",onClick:R,children:"Meeting Finished"})]}):e.jsxs(ie,{className:"bg-green-100 text-green-800 border-green-200 w-full justify-center py-1",children:[e.jsx(us,{className:"h-3 w-3 mr-1"}),"Meeting Done"]}):e.jsxs("div",{className:"space-y-2",children:[e.jsx(He,{htmlFor:`meeting-date-${s.id}`,className:"text-xs text-muted-foreground",children:"Schedule Meeting"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(A,{id:`meeting-date-${s.id}`,type:"datetime-local",className:"h-8 text-xs",value:S,onChange:a=>O(a.target.value),onClick:a=>a.stopPropagation()}),e.jsx(p,{size:"sm",className:"h-8 px-2",onClick:V,disabled:!S,children:"Set"})]})]})})]}),e.jsx(js,{children:r&&e.jsx(re.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},transition:{duration:.3,ease:"easeInOut"},className:"overflow-hidden",children:e.jsxs("div",{className:"border-t p-4 space-y-4",children:[e.jsxs("h4",{className:"text-xs font-semibold uppercase text-muted-foreground flex items-center gap-2",children:[e.jsx(Ue,{className:"h-4 w-4"})," Notes"]}),e.jsx("div",{className:"space-y-3 max-h-48 overflow-y-auto pr-2",children:s.notes&&s.notes.length>0?[...s.notes].reverse().map(a=>e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(X,{className:"h-6 w-6",children:e.jsx(ee,{className:"text-xs",children:W(a.authorName)})}),e.jsxs("div",{className:"flex-1 bg-muted/50 p-2 rounded-md",children:[e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsx("span",{className:"font-medium",children:_(a.authorName)}),e.jsx("span",{className:"text-muted-foreground",children:gs(new Date(a.createdAt),{addSuffix:!0})})]}),e.jsx("p",{className:"text-sm mt-1",children:a.content})]})]},a.id)):e.jsx("p",{className:"text-xs text-muted-foreground text-center py-4",children:"No notes yet."})}),e.jsxs("div",{className:"flex gap-2 items-start",onClick:a=>a.stopPropagation(),children:[e.jsx(X,{className:"h-8 w-8 mt-1",children:e.jsx(ee,{className:"text-xs",children:l!=null&&l.displayName?W(l.displayName):"U"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx(xs,{placeholder:"Add a note...",className:"text-sm",rows:2,value:m,onChange:a=>y(a.target.value)}),e.jsxs(p,{size:"sm",className:"mt-2",onClick:B,disabled:!m.trim(),children:[e.jsx($e,{className:"h-3 w-3 mr-2"})," Add Note"]})]})]})]})})})]})})},te=({title:s,opportunities:x,onEdit:v,onDelete:r,expandedOppId:h,setExpandedOppId:n,isSearchable:u,searchTerm:C,onSearchChange:N,hasMore:w,onLoadMore:b,totalCount:g})=>{const{setNodeRef:j}=ce({id:s});return e.jsxs("div",{ref:j,className:"w-72 flex-shrink-0 bg-muted/50 rounded-xl flex flex-col h-full",children:[e.jsxs("div",{className:"p-4 border-b space-y-2",children:[e.jsxs("h3",{className:"font-semibold text-sm flex items-center justify-between",children:[s,e.jsx(ie,{variant:"secondary",children:g!==void 0?g:x.length})]}),u&&e.jsxs("div",{className:"relative",children:[e.jsx(Ae,{className:"absolute left-2 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(A,{placeholder:"Search leads...",value:C,onChange:l=>N==null?void 0:N(l.target.value),className:"pl-8 h-8"})]})]}),e.jsx(es,{items:x.map(l=>l.id),strategy:ss,children:e.jsxs("div",{className:"p-2 flex-1 overflow-y-auto",children:[x.map(l=>e.jsx(me,{opportunity:l,onEdit:v,onDelete:r,isExpanded:h===l.id,onExpand:()=>n(h===l.id?null:l.id)},l.id)),w&&e.jsx("div",{className:"flex justify-center mt-2",children:e.jsx(p,{variant:"ghost",size:"sm",onClick:b,children:"Load More"})})]})})]})};function Es(){const{opportunities:s,updateOpportunity:x,addOpportunity:v,deleteOpportunity:r,loading:h,addOpportunitiesFromContacts:n}=le(),{contacts:u,loading:C}=Me();Oe();const[N,w]=d.useState(null),[b,g]=d.useState(!1),[j,l]=d.useState(null),[m,y]=d.useState(null),[S,O]=d.useState(null),[k,B]=d.useState(""),[V,R]=d.useState(15),_=Qe(Ye(Xe,{activationConstraint:{distance:8}}));d.useEffect(()=>{if(!(h||C)&&u.length>0){const t=u.filter(c=>c.callHistory&&c.callHistory.some(i=>i.feedback==="Interested"));t.length>0&&n(t)}},[u,h,C]);const W=d.useMemo(()=>s.filter(t=>t.stage!=="Closed Won"&&t.stage!=="Closed Lost").reduce((t,c)=>t+c.value,0),[s]),a=d.useMemo(()=>s.filter(t=>t.stage==="Closed Won").reduce((t,c)=>t+c.value,0),[s]),q=t=>{const{active:c}=t;w(s.find(i=>i.id===c.id)||null),O(null)},xe=()=>{w(null)},he={sideEffects:Ke({styles:{active:{opacity:"0.5"}}})},ue=t=>{const{active:c,over:i}=t;if(w(null),!i)return;const f=c.id,o=i.id;if(f===o)return;const L=s.find(U=>U.id===f);if(!L)return;const z=se.includes(o),D=s.find(U=>U.id===o),H=z?o:D==null?void 0:D.stage;H&&L.stage!==H&&x(f,{stage:H})},ge=async t=>{j?await x(j.id,t):await v(t),g(!1),l(null)},Y=()=>{g(!1),l(null)},Z=t=>{l(t),g(!0)},G=t=>{y(t)},je=()=>{m&&(r(m.id),y(null))};return h||C?e.jsx(os,{}):e.jsxs("div",{className:"h-full flex flex-col p-6",children:[e.jsx(re.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{duration:.5},children:e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Sales Opportunities"}),e.jsx("p",{className:"text-muted-foreground",children:"Manage your sales pipeline from lead to close."})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex gap-4",children:[e.jsx($,{className:"w-52",children:e.jsxs(Q,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("p",{className:"text-xs font-medium text-muted-foreground",children:"Total Pipeline Value"}),e.jsx(de,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs("div",{className:"text-xl font-bold",children:["₹",W.toLocaleString()]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["from ",s.filter(t=>t.stage!=="Closed Won"&&t.stage!=="Closed Lost").length," opportunities"]})]})}),e.jsx($,{className:"w-52",children:e.jsxs(Q,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("p",{className:"text-xs font-medium text-muted-foreground",children:"Total Won Value"}),e.jsx(hs,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs("div",{className:"text-xl font-bold text-green-600",children:["₹",a.toLocaleString()]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["from ",s.filter(t=>t.stage==="Closed Won").length," deals"]})]})})]}),e.jsxs(ke,{open:b,onOpenChange:t=>{t?g(!0):Y()},children:[e.jsx(Ie,{asChild:!0,children:e.jsxs(p,{variant:"focus",children:[e.jsx(Te,{className:"h-4 w-4 mr-2"})," New Opportunity"]})}),e.jsxs(Fe,{children:[e.jsx(Pe,{children:e.jsx(Ee,{children:j?"Edit Opportunity":"Create New Opportunity"})}),e.jsx(Ns,{opportunity:j||void 0,onSubmit:ge,onCancel:Y})]})]})]})]})}),e.jsxs(Ze,{sensors:_,onDragStart:q,onDragEnd:ue,onDragCancel:xe,collisionDetection:Ge,children:[e.jsx("div",{className:"flex-1 flex gap-6 overflow-x-auto pb-4",children:se.map(t=>{let c=s.filter(i=>i.stage===t);if(t==="Meeting"&&c.sort((i,f)=>{const o=D=>D.meetingStatus==="done"?3:D.meetingDate&&D.meetingStatus==="scheduled"?1:2,L=o(i),z=o(f);return L!==z?L-z:L===1&&i.meetingDate&&f.meetingDate?new Date(i.meetingDate).getTime()-new Date(f.meetingDate).getTime():0}),t==="Interested Lead"){const i=c.filter(o=>o.title.toLowerCase().includes(k.toLowerCase())||o.contact.toLowerCase().includes(k.toLowerCase())),f=i.slice(0,V);return e.jsx(te,{title:t,opportunities:f,onEdit:Z,onDelete:G,expandedOppId:S,setExpandedOppId:O,isSearchable:!0,searchTerm:k,onSearchChange:B,hasMore:i.length>V,onLoadMore:()=>R(o=>o+15),totalCount:i.length},t)}return e.jsx(te,{title:t,opportunities:c,onEdit:Z,onDelete:G,expandedOppId:S,setExpandedOppId:O},t)})}),e.jsx(Je,{dropAnimation:he,children:N?e.jsx(me,{opportunity:N,onEdit:()=>{},onDelete:()=>{},isExpanded:!1,onExpand:()=>{}}):null})]}),e.jsx(ds,{open:!!m,onOpenChange:t=>!t&&y(null),onConfirm:je,title:"Delete Opportunity",itemName:m==null?void 0:m.title})]})}export{Es as default};
